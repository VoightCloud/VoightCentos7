- name: Initialize Kubernetes Control Plane
  hosts: all
  tasks:
    - name: Common Tasks
      include_tasks: all-playbook.yaml

    - name: Enable NFS
      systemd:
        name: nfs-server
        enabled: yes
        state: started
      become: true

    - name: Create NFS Share Directory
      file:
        path: /volume
        state: directory
        owner: nfsnobody
        group: nfsnobody
        mode: 755
      become: true

    - name: Update exports
      become: true
      lineinfile:
        path: /etc/exports
        line: '/volume           192.168.50.0/24(rw,sync,no_root_squash,no_subtree_check)'

    - name: Export volume
      command: exportfs -a
      become: true

    - name: Insert a rule on line 1
      iptables:
        chain: INPUT
        protocol: tcp
        destination_port: "{{ item }}"
        jump: ACCEPT
        action: insert
        rule_num: 1
      with_items:
        - 6443
        - 4149
        - 10250
        - 10255
        - 10256
        - 9099
        - 2049
      become: true

    - name: Insert a rule on line 1
      iptables:
        chain: INPUT
        protocol: udp
        destination_port: 8472
        jump: ACCEPT
        action: insert
        rule_num: 1
      become: true

    - name: Initialize the Kubernetes cluster using kubeadm
      become: true
      command: >
        kubeadm init --apiserver-advertise-address="192.168.50.210" --apiserver-cert-extra-sans="192.168.50.210"
        --pod-network-cidr=100.64.0.0/16 --service-cidr=100.65.0.0/16

    - name: Generate join command
      command: kubeadm token create --print-join-command
      become: true
      register: join_command

    - name: Copy join command to local file
      become: false
      local_action: copy content="{{ join_command.stdout_lines[0] }}" dest="./tmpfiles/join-command"

    - name: Create .kube directory for ubuntu
      file:
        path: /home/centos/.kube
        state: directory
        owner: centos
        group: centos
        mode: '0700'

    - name: Copy kubeconfig
      become: true
      copy:
        src: /etc/kubernetes/admin.conf
        dest: /home/centos/.kube/config
        remote_src: yes
        owner: centos
        group: centos
        mode: '0700'

    - name: Get Helm
      unarchive:
        remote_src: yes
        src: https://get.helm.sh/helm-v3.3.4-linux-amd64.tar.gz
        dest: /home/centos/
      when: ansible_architecture == "x86_64"

    - name: Get Helm
      unarchive:
        remote_src: yes
        src: https://get.helm.sh/helm-v3.3.4-linux-arm64.tar.gz
        dest: /home/centos/
      when: ansible_architecture == "aarch64"

    - name: Move Helm package
      command: "{{ item }}"
      become: true
      when: ansible_architecture == "aarch64"
      args:
        warn: false
      with_items:
        - mv /home/centos/linux-arm64/helm /usr/local/bin/helm
        - rm -r /home/centos/linux-arm64/

    - name: Move Helm package
      command: "{{ item }}"
      become: true
      when: ansible_architecture == "x86_64"
      args:
        warn: false
      with_items:
        - mv /home/centos/linux-amd64/helm /usr/local/bin/helm
        - rm -r /home/centos/linux-amd64/

    - name: Install bitnami repos
      community.kubernetes.helm_repository:
        name: bitnami
        repo_url: "https://charts.bitnami.com/bitnami"

    - name: Install stable repos
      community.kubernetes.helm_repository:
        name: stable
        repo_url: "https://charts.helm.sh/stable"

    - name: Install oteemocharts repos
      community.kubernetes.helm_repository:
        name: oteemocharts
        repo_url: "https://oteemo.github.io/charts"

    - name: Install elastic repos
      community.kubernetes.helm_repository:
        name: elastic
        repo_url: "https://helm.elastic.co"

    - name: Install dashboard repos
      community.kubernetes.helm_repository:
        name: kubernetes-dashboard
        repo_url: "https://kubernetes.github.io/dashboard"

    - name: Install jenkins repos
      community.kubernetes.helm_repository:
        name: jenkins
        repo_url: "https://charts.jenkins.io"

    - name: Install hashicorp repos
      community.kubernetes.helm_repository:
        name: hashicorp
        repo_url: "https://helm.releases.hashicorp.com"

    - name: Install NextCloud repos
      community.kubernetes.helm_repository:
        name: nextcloud
        repo_url: "https://nextcloud.github.io/helm/"

    - name: Install cetic repos
      community.kubernetes.helm_repository:
        name: cetic
        repo_url: "https://cetic.github.io/helm-charts"

    - name: Install haproxy repos
      community.kubernetes.helm_repository:
        name: haproxy
        repo_url: "https://haproxytech.github.io/helm-charts"

    - name: Update helm repos
      command: helm repo update

    - name: Copy kubernetes yaml
      copy:
        src: ./kubernetes
        dest: /tmp

    - name: Install flannel
      command: "{{ item }}"
      with_items:
        - kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml -f /tmp/kubernetes/flannel-values.yaml
        - kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/k8s-manifests/kube-flannel-rbac.yml

    - name: Install Metal-LB
      command: helm install -n default metallb stable/metallb -f /tmp/kubernetes/metallb-values.yaml

    - name: Install namespaces
      command: kubectl apply -f /tmp/kubernetes/namespaces.yaml

    - name: Apply storage chart
      command: helm install storage-nfs stable/nfs-client-provisioner  -f /tmp/kubernetes/nas-values.yaml


